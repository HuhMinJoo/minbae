<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <button id="btnSend" class="btn btn-primary">Send Message</button>
    <button id="assignbutton" onclick="assign()" >받기</button>
<div id="print_div"></div>

<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const mem = JSON.parse(window.sessionStorage.getItem("memberData")).memberData;
    let tradeIdx;
    function assign(){
        data={
            deliverIdx:Number(mem.deliverIdx),tradeIdx:Number(129)
        }
        fetch("/deliver/assign/complete",{
            method:"put",
            headers:{"Content-Type":"application/json; charset=UTF-8"},
            body:JSON.stringify(data)
        });
    }
    $(document).ready(  function() {
        connectStomp();

        $('#btnSend').on('click', function(evt) {
            evt.preventDefault();
            data={
                "storeLat":bbb,"storeLng":aaa
            }
                socket.send('/app/chat/assign', {}, JSON.stringify({"storeLat":37.55,"storeLng":126.943}));
        });
    });


    var socket = null;
    var isStomp = false;


    function connectStomp() {
        var sock = new SockJS("/deliver");
        var client = Stomp.over(sock);
        isStomp = true;
        socket = client;
        socket.connect({}, function (frame) {
            socket.subscribe('/topic/deliver/'+mem.deliverIdx,function (event){
                var message=JSON.parse(event.body);
                if(message.message=="상점"){
                    var div1 = document.createElement("div");
                    var div2 = document.createElement("div");
                    div2.innerText="가게이름";
                    var div3 = document.createElement("div");
                    div3.innerText="가게 주소";
                    var div4 = document.createElement("div");
                    div4.innerText="배달 주소";
                    div1.append(div2);
                    div1.append(div3);
                    div1.append(div4);
                    document.getElementById("print_div").append(div1);
                }
            });
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude,
                            lon = position.coords.longitude;
                    setInterval(function(){
                        socket.send('/app/chat/refresh',{},JSON.stringify({"id":mem.deliverIdx,"lat":lat,"lng":lon}))
                    },10000);
                });
            }
        });
    }


</script>
</body>
</html>