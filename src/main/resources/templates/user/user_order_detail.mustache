<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
{{>layout/main/main_header}}

    <h2 style="text-align: center">주문 현황</h2>
    <hr>
    <div id="order_state_list">

    </div>
{{>layout/main/main_footer}}
</body>
<script>
    let get_login = JSON.parse(sessionStorage.getItem("memberData"));
    let user_idx = get_login.memberData.userIdx;

    console.log(user_idx)

    fetch(`/user/order/state/${user_idx}`)
            .then((response) => response.json())
            .then((data) => {

                data.data.forEach( data => {
                    let order_date = new Date(data.order_date);
                    let order_state = '';
                    if(data.order_state == 0){
                        order_state = '접수 완료/접수 대기중';
                    }else if(data.order_state == 1){
                        order_state = '주문 수락/조리중';
                    }else if(data.order_state == 2){
                        order_state = '배달중';
                    }else if(data.order_state == 3){
                        order_state = '배달 완료';
                    }else if(data.order_state == 4){
                        order_state = '주문 거절';
                    }

                    let order_store_text = `<div class="card mb-3" style="max-width: 750px;">
                                              <div class="row g-0">
                                                <div class="col-md-8">
                                                  <div class="card-body">
                                                    <h5 class="card-title">${data.store_name}</h5>
                                                    <p class="card-text"><small class="text-muted">*주문 일시 : </small><span style="font-size: small">${order_date.toLocaleDateString()}</span></p>
                                                    <p class="card-text" style="color: cornflowerblue">${order_state}</p>
                                                  </div>
                                                </div>
                                             </div>
                                          </div>`
                    // let order_store_text = `<div>
                    //                         <div><label>가게 이름</label>:${data.store_name}</div>
                    //                         <div><label>주문 일시</label>:${order_date.toLocaleDateString()}</div>
                    //                         <div><label>주문 상태</label>:${order_state}</div>
                    //                     </div>
                    //                     <hr>`
                    let div_order_state = document.createElement('div');
                    div_order_state.innerHTML = order_store_text
                    let order_state_list = document.getElementById('order_state_list');
                    order_state_list.appendChild(div_order_state);
                } )
            });

    //소켓연결
    let socket = new SockJS('/chat');
    let stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        //응답 받기
        stompClient.subscribe(`/topic/user/${user_idx}`, function (greeting) {
            location.reload();
            // let j_parse = JSON.parse(greeting.body);
            // let message = j_parse.message;
            // if(message){
            //     location.reload();
            // }
        });
    });
</script>
</html>
